// Скрипт на событии: "Изменение объекта" (после сохранения)
// Цель: при смене типа запроса вернуть прежний статус (state).

// 1) Тип изменился?
def typeChanged = (subject?.serviceType?.id ?: 0) != (oldSubject?.serviceType?.id ?: 0)
if (!typeChanged) return

// 2) Прежний статус существует?
def oldState = oldSubject?.state                    // ВАЖНО: берем сам объект статуса, а не code-строку
if (oldState == null) return

// 3) Система успела сбросить статус в "registered"?
def isRegisteredNow = "registered".equalsIgnoreCase(subject?.state?.code ?: "")
if (!isRegisteredNow) return

// 4) Уже и так прежний? — ничего не делаем
if (subject?.state?.id == oldState?.id) return

// 5) Вернём прежний статус
utils.edit(subject, [ state: oldState ])
// Повторного срабатывания цикла не будет, т.к. при следующем апдейте typeChanged = false.