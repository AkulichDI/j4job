// Скрипт для события "Изменение объекта" на классе Запрос
// Событие: Изменение объекта
// Условие срабатывания: всегда

// Получаем текущее состояние запроса
def currentState = subject.state
def currentStateCode = currentState?.code

logger.info("=== Контроль статуса при изменении типа ===")
logger.info("UUID запроса: ${subject.UUID}")
logger.info("Текущий статус: ${currentStateCode}")
logger.info("Текущий тип запроса: ${subject.serviceCall?.code}")

// Проверяем, не сброшен ли статус в "Зарегистрирован"
// при том что запрос уже был в работе
if (currentStateCode == 'registered') {
    
    // Получаем объект заново из БД для проверки реального состояния
    def requestFromDB = utils.get(subject.UUID)
    
    // Проверяем историю статусов через связанные объекты
    // или используем дополнительное поле для хранения "желаемого" статуса
    
    def targetState = subject.getAttrValue('targetStateAfterReclassification')
    
    if (targetState != null && targetState.code != 'registered') {
        logger.info("Обнаружен целевой статус для восстановления: ${targetState.code}")
        
        // Устанавливаем нужный статус
        utils.edit(subject.UUID, [
            state: targetState,
            targetStateAfterReclassification: null  // Очищаем после использования
        ])
        
        logger.info("Статус восстановлен: ${targetState.code}")
    }
}