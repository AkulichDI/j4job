// ========================================
// СКРИПТ СОХРАНЕНИЯ СТАТУСА ПРИ СМЕНЕ ТИПА
// Событие: Изменение объекта
// ========================================

try {
    logger.info("=== Проверка сохранения статуса ===")
    
    // ВАЖНО: Используем safe navigation и getAttrValue
    def currentState = subject.state
    if (currentState == null) {
        logger.info("Статус не установлен, выход")
        return
    }
    
    def stateCode = currentState?.code
    logger.info("Текущий статус: ${stateCode}")
    
    // Получаем сохраненный статус
    def preservedStatus = subject.getAttrValue('preservedStatus')
    
    // ВАРИАНТ 1: Восстановление статуса
    if (stateCode == 'registered' && preservedStatus != null) {
        logger.info("Обнаружен сохраненный статус: ${preservedStatus.code}")
        
        utils.edit(subject.UUID, [
            state: preservedStatus,
            preservedStatus: null
        ])
        
        logger.info("Статус восстановлен: ${preservedStatus.code}")
    }
    // ВАРИАНТ 2: Сохранение статуса
    else if (stateCode != 'registered') {
        logger.info("Сохраняем текущий статус: ${stateCode}")
        
        utils.edit(subject.UUID, [
            preservedStatus: currentState
        ])
    }
    
    logger.info("=== Конец проверки ===")
    
} catch (Exception e) {
    logger.error("ОШИБКА: ${e.message}", e)
}